# ---------- Stage 1: Base dependencies (for caching) ----------
FROM node:18-alpine AS deps

WORKDIR /app

# Copy dependency files only (better cache)
COPY package*.json ./

# Install all deps using your proxy
RUN npm install --legacy-peer-deps

# ---------- Stage 2: Build Stage ----------
FROM node:18-alpine AS build

WORKDIR /app

# Copy node_modules from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy project files
COPY . .

# Ensure static export mode is disabled
# (comment out or remove `output: 'export'` in next.config.js)
RUN npm run build

# ---------- Stage 3: Production Runtime ----------
FROM node:18-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=4000

# Install runtime tools (gettext provides envsubst)
RUN apk add --no-cache gettext

# Copy only essential files
COPY package*.json ./
RUN npm install --omit=dev --legacy-peer-deps

# Copy built artifacts and static assets
COPY --from=build /app/.next ./.next
COPY --from=build /app/public ./public
COPY --from=build /app/next.config.js ./next.config.js

# (Optional) If you use custom fonts or other assets
# COPY --from=build /app/.env ./.env

# ---------- Inject Runtime Config Support ----------
# Copy our entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 4000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["npm", "start"]
